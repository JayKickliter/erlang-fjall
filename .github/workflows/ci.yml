name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  CARGO_TERM_COLOR: always

jobs:
  ci:
    name: OTP${{ matrix.otp }}-${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest]
        otp: [27]

    steps:
    - uses: actions/checkout@v2

    - name: Cache | Rust
      uses: actions/cache@v4
      with:
        key: ci-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: ci-${{ runner.os }}-cargo
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          _build/native/

    - name: Cache | Erlang
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/rebar3
          _build/default
          _build/test
        key: ci-${{ runner.os }}-otp${{ matrix.otp }}-${{ hashFiles('rebar.lock') }}
        restore-keys: |
          ci-${{ runner.os }}-otp${{ matrix.otp }}

    - name: Toolchain | Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: ${{ matrix.otp }}
        rebar3-version: 'latest'

    - name: Toolchain | Rust
      uses: dtolnay/rust-toolchain@stable
      with:
        components: clippy,rustfmt

    - name: Erlang | Compile
      run: rebar3 compile

    - name: Erlang | Eunit
      run: rebar3 eunit

    - name: Erlang | Dialyzer
      run: rebar3 dialyzer

    - name: Erlang | Fmt
      run: rebar3 fmt --check

    - name: Rust | Fmt
      run: cargo fmt --all -- --check

    - name: Rust | Clippy
      run: cargo clippy --release -- -Dclippy::all -D unsafe_code

  docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    needs: ci
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
    - uses: actions/checkout@v4

    - name: Cache | Rust
      uses: actions/cache@v4
      with:
        key: docs-${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
        restore-keys: docs-${{ runner.os }}-cargo
        path: |
          ~/.cargo/bin/
          ~/.cargo/registry/index/
          ~/.cargo/registry/cache/
          ~/.cargo/git/db/
          _build/native/

    - name: Cache | Erlang
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/rebar3
          _build/default
        key: docs-${{ runner.os }}-otp27-${{ hashFiles('rebar.lock') }}
        restore-keys: |
          docs-${{ runner.os }}-otp27

    - name: Toolchain | Erlang/OTP
      uses: erlef/setup-beam@v1
      with:
        otp-version: 27
        rebar3-version: 'latest'

    - name: Toolchain | Rust
      uses: dtolnay/rust-toolchain@stable

    - name: Build | Documentation
      run: |
        rebar3 ex_doc

    - name: Setup | Pages
      uses: actions/configure-pages@v4

    - name: Upload | Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: "doc"

    - name: Deploy | Pages
      id: deployment
      uses: actions/deploy-pages@v4
